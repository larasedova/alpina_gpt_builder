name: Build and Deploy to VPS

on:
  push:
    branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Setup VPS and Deploy
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          # Установка Docker (если не установлен)
          if ! command -v docker &> /dev/null; then
            echo "Устанавливаем Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sh get-docker.sh
          fi

          # Установка Docker Compose (если не установлен)
          if ! command -v docker-compose &> /dev/null; then
            echo "Устанавливаем Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          fi

          # Установка firewall
          if ! command -v ufw &> /dev/null; then
            echo "Устанавливаем UFW..."
            apt update && apt install ufw -y
          fi

          # Настройка firewall (только если не настроен)
          if ufw status | grep -q "inactive"; then
            echo "Настраиваем firewall..."
            ufw allow ssh
            ufw allow http
            ufw allow https
            ufw --force enable
          fi

          # Создаем директорию проекта
          mkdir -p /opt/alpina_gpt_builder/nginx
          cd /opt/alpina_gpt_builder

          # Создаем docker-compose.yml
          cat > docker-compose.yml << 'DOCKERCOMPOSE'
          version: '3.8'

          services:
            web:
              image: ghcr.io/larasedova/alpina_gpt_builder:latest
              container_name: alpina_web
              command: >
                sh -c "python manage.py migrate --noinput &&
                       python manage.py collectstatic --noinput &&
                       gunicorn --bind 0.0.0.0:8000 --workers 3 bot_builder.wsgi:application"
              volumes:
                - static_volume:/app/staticfiles
                - media_volume:/app/media
              env_file:
                - .env
              environment:
                - DATABASE_URL=postgres://alpina_user:alpina_password@db:5432/alpina_db
              expose:
                - "8000"
              depends_on:
                - db
              restart: unless-stopped
              networks:
                - alpina_network

            nginx:
              image: nginx:1.25-alpine
              container_name: alpina_nginx
              volumes:
                - ./nginx/nginx.conf:/etc/nginx/nginx.conf
                - static_volume:/app/staticfiles
                - media_volume:/app/media
              ports:
                - "80:80"
              depends_on:
                - web
              restart: unless-stopped
              networks:
                - alpina_network

            db:
              image: postgres:15-alpine
              container_name: alpina_db
              volumes:
                - postgres_data:/var/lib/postgresql/data/
              environment:
                - POSTGRES_DB=alpina_db
                - POSTGRES_USER=alpina_user
                - POSTGRES_PASSWORD=alpina_password
              restart: unless-stopped
              networks:
                - alpina_network

          volumes:
            postgres_data:
            static_volume:
            media_volume:

          networks:
            alpina_network:
              driver: bridge
          DOCKERCOMPOSE

          # Создаем конфигурацию nginx
          mkdir -p nginx
          cat > nginx/nginx.conf << 'NGINXCONF'
          events {
              worker_connections 1024;
          }

          http {
              include /etc/nginx/mime.types;
              default_type application/octet-stream;

              log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                              '$status $body_bytes_sent "$http_referer" '
                              '"$http_user_agent" "$http_x_forwarded_for"';

              access_log /var/log/nginx/access.log main;
              error_log /var/log/nginx/error.log;

              sendfile on;
              tcp_nopush on;
              tcp_nodelay on;
              keepalive_timeout 65;
              types_hash_max_size 2048;

              gzip on;
              gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

              upstream django {
                  server web:8000;
              }

              server {
                  listen 80;
                  server_name _;

                  location /static/ {
                      alias /app/staticfiles/;
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }

                  location /media/ {
                      alias /app/media/;
                      expires 1y;
                      add_header Cache-Control "public, immutable";
                  }

                  location / {
                      proxy_pass http://django;
                      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                      proxy_set_header X-Forwarded-Proto $scheme;
                      proxy_set_header Host $host;
                      proxy_redirect off;

                      proxy_connect_timeout 60s;
                      proxy_send_timeout 60s;
                      proxy_read_timeout 60s;
                  }
              }
          }
          NGINXCONF

          # Создаем .env файл с секретами
          cat > .env << ENVFILE
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          DEBUG=False
          ALLOWED_HOSTS=${{ secrets.VPS_HOST }},localhost,127.0.0.1
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          DB_NAME=alpina_db
          DB_USER=alpina_user
          DB_PASSWORD=alpina_password
          DB_HOST=db
          DB_PORT=5432
          REDIS_URL=redis://redis:6379/0
          ENVFILE

          # Логинимся в GitHub Container Registry
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

          # Останавливаем старые контейнеры если есть
          docker-compose down || true

          # Запускаем контейнеры
          docker-compose pull
          docker-compose up -d --force-recreate

          # Ждем запуска и проверяем
          sleep 30
          docker-compose ps
          docker-compose logs web
          